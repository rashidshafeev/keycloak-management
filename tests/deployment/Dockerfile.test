# Use the official Docker-in-Docker image
FROM docker:dind

# Install basic dependencies
RUN apk add --no-cache \
    bash \
    sudo \
    curl \
    wget \
    git \
    python3 \
    py3-pip \
    ca-certificates \
    gnupg \
    docker-cli \
    docker-compose

# Create required directories
RUN mkdir -p /var/log /var/run /etc/docker

# Configure Docker daemon
RUN echo '{"debug": true, "log-level": "debug"}' > /etc/docker/daemon.json

# Create app directory and make it the working directory
WORKDIR /app

# Copy repository contents
COPY . .

# Make scripts executable
RUN chmod +x install.sh tests/deployment/test-entrypoint.sh

# Set entrypoint with Docker daemon startup
ENTRYPOINT ["dockerd-entrypoint.sh", "./tests/deployment/test-entrypoint.sh"]
